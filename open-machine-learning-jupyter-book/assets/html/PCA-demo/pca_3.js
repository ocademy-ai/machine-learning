function temp1(){}function test1(){table2=[[1,4,1,4,5],[5,2,4,4,5],[3,6,3,1,2],[1,3,2,1,3]],jStat.PCA([[1,5,1,5,8],[2,5,4,3,1],[3,6,2,2,2],[4,7,3,1,2]])}function example_data(){adj_table_col("table1",5),GEBI("c0").value="A\nA\nB\nB\nB",GEBI("c1").value="1\n5\n1\n5\n8",GEBI("c2").value="2\n5\n4\n3\n1",GEBI("c3").value="3\n6\n2\n2\n2",GEBI("c4").value="4\n7\n3\n1\n2",set_var("h1","X-1"),set_var("h2","X-2"),set_var("h3","X-3"),set_var("h4","X-4"),GEBI("table1").scrollIntoView({behavior:"smooth"}),set_variable("table2","*ID/Group\tX-1\tX-2\tX-3\tX-4\nA\t1\t2\t3\t4\nA\t5\t5\t6\t7\nB\t1\t4\t2\t3\nB\t5\t3\t2\t1\nB\t8\t1\t2\t2\n"),change_h1()}function example_data_id0(){adj_table_col("table1",5),set_var("c0","A\nA\nB\nB\nB"),set_var("c1","ID1\nID2\nID3\nID4\nID5"),set_var("c2","2\n5\n4\n3\n1"),set_var("c3","3\n6\n2\n2\n2"),set_var("c4","4\n7\n3\n1\n2"),set_var("h1","ID"),set_var("h2","X-1"),set_var("h3","X-2"),set_var("h4","X-3"),GEBI("table1").scrollIntoView({behavior:"smooth"}),set_variable("table2","*ID/Group\tID\tX-1\tX-2\tX-3\nA\tc1\t2\t3\t4\nA\tc2\t5\t6\t7\nB\tc3\t4\t2\t3\nB\tc4\t3\t2\t1\nB\tc5\t1\t2\t2\n")}function example_data_id(){adj_table_col("table1",6),set_var("c0","Africa\nAfrica\nAfrica\nAsia\nAsia\nAsia\nEurope\nEurope\nEurope\n"),set_var("c1","Egypt\nNigeria\nKenya\nChina\nIndia\nJapan\nGermany\nUnited Kingdom\nFrance\n"),set_var("c2","$3,924\n$2,097\n$1,912\n$9,532\n$2,097\n$39,853\n$49,939\n$43,927\n$41,831\n"),set_var("c3","32.9\n48.8\n47.9\n42.1\n33.9\n32.7\n30.5\n34\n32.5\n"),set_var("c4","0.7\n0.504\n0.527\n0.758\n0.647\n0.917\n0.939\n0.906\n0.909\n"),set_var("c5","94\n214\n91\n146\n464\n348\n237\n401\n121\n"),set_var("h0","Continent(Series)"),set_var("h1","Country"),set_var("h2","GDPpC"),set_var("h3","Gini (2021)"),set_var("h4","HDI (2021)"),set_var("h5","Density (per sq)"),GEBI("table1").scrollIntoView({behavior:"smooth"}),set_variable("table2","Continent\tCountry\tGDPpC\tGini (2021)\tHDI (2021)\tDensity (people per sq km)\nAfrica\tEgypt\t$3,924\t32.9\t0.7\t94\nAfrica\tNigeria\t$2,097\t48.8\t0.504\t214\nAfrica\tKenya\t$1,912\t47.9\t0.527\t91\nAsia\tChina\t$9,532\t42.1\t0.758\t146\nAsia\tIndia\t$2,097\t33.9\t0.647\t464\nAsia\tJapan\t$39,853\t32.7\t0.917\t348\nEurope\tGermany\t$49,939\t30.5\t0.939\t237\nEurope\tUnited Kingdom\t$43,927\t34\t0.906\t401\nEurope\tFrance\t$41,831\t32.5\t0.909\t121\n"),change_h1()}function example_data2(){adj_table_col("table1",5),GEBI("c0").value="A\nA\nB\nB\nB",GEBI("c1").value="1\n4\n1\n4\n5",GEBI("c2").value="5\n2\n4\n4\n5",GEBI("c3").value="3\n6\n3\n1\n2",GEBI("c4").value="1\n3\n2\n1\n3",GEBI("table1").scrollIntoView({behavior:"smooth"})}function scree_data(e,t,r){var a=e[1],n=copy_2d_array(a);each_arr(n,xrd,r);var o={x:e[0],y:a,name:"Eigenvalue",type:"bar",marker:{color:t.colors[0],line:{color:t.borderColor,width:t.borderWidth}}};o.text=n.map(String),o.textposition="auto";var l={x:e[0],y:e[3],name:"Cumulative (%)",yaxis:"y2",type:"scatter",line:{color:t.colors[1]}},s=copy_2d_array(e[3]);return each_arr(s,xrd,r),l.text=s.map(String),l.textposition="top",l.textFont={family:"sans serif",size:18,color:"#ff0000"},[o,l]}function chart_data2(e,t,r,a,n,o,l,s){var i,c,h,_,u,v=[];colors=s.colors.splice(0,l.length),n<=2?_="scatter":3==n&&(_="scatter3d");for(let t=0;t<a;t++)e.push(o[t]),e.push(o[t]),colors.push(s.vColor);trim_array(e),t.length>0&&trim_array(t);var p=rotateArray(r,!1);p.reverse();for(var d=[],g=[],b=[],m=1,f=[],y=1;y<e.length;y++)1==y||e[y]==e[y-1]?(d.push(p[0][y]),1!=n?g.push(p[1][y]):g.push(0),3==n&&b.push(p[2][y]),t.length>0&&f.push(t[y]),1==n?h="top":2==n?(h=p[1][y]>=0?"top ":"bottom ",p[0][y]>=0?s.mirror_x?h+="left":h+="right":s.mirror_x?h+="right":h+="left"):3==n&&(h="middle center")):(x(),v.push(u),m++,d=[p[0][y]],g=1!=n?[p[1][y]]:[0],3==n&&(b=[p[2][y]]),t.length>0&&(f=[t[y]]));return x(),v.push(u),v;function x(){m<=l.length?(i="markers",s.marker,c=s.legend):(i="lines+text",{symbol:"arrow",size:12},f=["",o[m-l.length-1]],c=!1),u={x:d,y:g,z:b,name:e[y-1],mode:i,type:_,marker:s.marker,text:f,textposition:h,line:{color:colors[m-1]},showlegend:c}}}function local(){return"table2,type,title,title_fontSize,dimensions,scale1,digits,steps"}function show_color_buttons(e){var t,r;for(r=0;r<100;r++){if(t="cl"+r,color=get_var(t),null==color)return r;r<e?display_blocks(t,""):display_blocks(t,"none")}}function calculate_pca(){display_blocks("warning1,notes","none"),set_local_columns("pca","table1","c,h","",!1,0),set_local("pca",local(),"");var e,t,r,a,n,o,l,s,i,c,h=get_var("message1").length>0,_=get_var("type"),u=1*get_var("dimensions"),v=get_var("digits"),p="true"==get_var("scale1"),d=get_colors_bt(),g=get_var("title"),b=get_var("title_fontSize"),m=get_var("symbol1"),f=get_var("marker_size"),y=get_var("legend"),x=(y="true"==get_variable("legend"),get_variable("c_backgroundColor")),w=get_variable("backgroundColor"),I=get_variable("vColor"),B=get_var("mirror_x"),C=get_var("mirror_y"),E=get_var("showVector"),k=get_var("showExplain"),G=get_var("markerBorderWidth"),A=get_var("markerBorderColor"),T=get_var("borderColor"),D=1*get_var("borderWidth"),S=get_var("height1"),$=get_var("width1"),X="";for(h?($=get_var("width1"),S=get_var("height1"),e=get_var("width2"),t=get_var("height2")):(S=$=.7*Math.min(window.innerWidth,window.innerHeight),e=Math.floor(.7*window.innerWidth),t=window.innerWidth>window.innerHeight?Math.floor(.5*e):Math.floor(.7*e),set_var("width1",$),set_var("height1",S),set_var("width2",e),set_var("height2",t)),GEBI("chart1").style.height=S+"px",GEBI("chart1").style.width=$+"px",GEBI("chart2").style.height=t+"px",GEBI("chart2").style.width=e+"px",GEBI("manual").checked?(s=get_split_values(),a=(r=load_columns_range("table1",1,1,"empty",!1,"","",s)).table,array_to_number(a),n=r.full_col0,o=r.row0,l=r.col0):(g_excel=get_excel("table2","col",!0,!0,!0),a=g_excel.table,o=g_excel.row0,(n=copy_2d_array(g_excel.col0)).unshift(g_excel.corner),set_local("pca","table2",""),l=g_excel.col0);n.length<a[0].length+1;)n.push("");for(;n.length>a[0].length+1;)n.pop();0==count_numbers(a[0])||"ID"==o[0]?("<span class='text-info mb-2'>","ID"==o[0]?"Seeing as the header of the second column is 'ID', ":"Seeing as the second column doesn't include numbers, ","we use this column as a second header (to convey further information), and this data will be visible when hovering over the markers (points).</span><br>",i=a[0],a.splice(0,1),c=o.splice(0,1)[0],i.unshift(c)):i=[];var z=copy_2d_array(d);for(let e=0;e<30;e++)d.length<n.length&&(d=[...d,...z]);var P=count_numbers(a),V="";for(let e=1;e<P.length;e++)P[e]!=P[e-1]&&(V+=o[e]+" contains "+P[e]+" numbers, ",V+="while "+o[e-1]+" contains "+P[e-1]+" numbers.<br>",e++);if(V.length>0)return alert1(V,"warning1",!1),!1;var H=copy_2d_array(o);H.unshift("Group\\Group");var M=copy_2d_array(n);M.splice(0,1),M=[...new Set(M)];var j=pca(_,a,u,p);clean_empty_array(l),show_color_buttons(l.filter(onlyUnique).length);var W="<h5>Calculation steps</h5>";p?(W+=step_style("1. Standardize the range of each dimension:<br>"),W+=html_frac([["x<sub>scaled</sub> =","x - mean"],["","sd"]]),W+=step_style("The standardized table:<br>")):(W+=step_style("1. Center the range of each dimension:<br>"),W+="X<sub>centered</sub> =  x - mean<br>",W+=step_style("The centered table:<br>"));var L=rotateArray(j.std_table,!0,null,"");flipArray(L,!0),each_arr(L,xrd,v),make_table(L,o,n),W+=ce("t1",L,v),"cov"==_?(W+=step_style("2. Calculate the covariance matrix:<br>"),W+=html_frac([["Cov<sub>x₁,x₂</sub> =","Σ(x₁<sub>,i</sub> - x̄₁)(x₂<sub>,i</sub> - x̄₂)"],["","n - 1"]]),W+=step_style("The covariance matrix:<br>")):"cor"==_?(W+=step_style("2. Calculate the correlation matrix:<br>"),W+=html_frac([["r<sub>x₁,x₂</sub> =","Σ(x₁<sub>,i</sub> - x̄₁)(x₂<sub>,i</sub> - x̄₂)"],["","√( Σ(x₁<sub>,i</sub> - x̄₁)²*Σ(x₂<sub>,i</sub> - x̄₂)² )"]]),W+=step_style("The correlation matrix:<br>")):(W+=step_style("3. Calculate X<sup>T</sup>X:<br>"),W+=step_style("The result matrix:<br>"));var O=copy_2d_array(j.COV);make_table(O,o,H),W+=ce("st1",O,v);var R=rotateArray(j.evector,!0);flipArray(R,!0);var F=[];for(let e=0;e<R[0].length;e++)F.push("Vector"+(e+1));R.unshift(F),W+=step_style("Eigenvectors:<br>"),W+=ce("st2",R,v),W+=step_style("A eigenvector with reversed signs for all its components is still considered a valid solution!");table_class_def();var K="<h4><u>Eigenvalues</u></h4>",U=copy_2d_array(j.eval_table);U[0].unshift("Parameter"),U[1].unshift("Eigenvalue"),U[2].unshift("% of Variance"),U[3].unshift("Cumulative (%)"),each_arr(U,xrd,v),K+=ce("t1",U,v);var q=copy_2d_array(j.scores_total);each_arr(q,xrd,v),K+="<h4><u>Scores</u></h4>",make_table(q,"",n),K+=ce("t2",q,v),set_variable("tab1",K),set_variable("rmessage",j.r_code),set_variable("steps1",W);var J,N="PC₁",Q="PC₂";k&&(N+=" ("+xrd(j.eval_table[2][0],2)+"%)",Q+=" ("+xrd(j.eval_table[2][1],2)+"%)",J=g+" <sub>("+xrd(j.eval_table[3][u-1],2)+"%)</sub>");var Y={xaxis:{title:{text:N},color:"black"},yaxis:{title:{text:Q},color:"black"},title:J,titlefont:{size:b},paper_bgcolor:x,plot_bgcolor:w,showlegend:y,marker:{symbol:m}};1==u&&(Y.yaxis={}),3==u&&(Y.margin={l:0,r:0,b:0,t:0});var Z=minMaxInColumns(j.scores_plus);B&&(Y.xaxis.range=[1.1*Z.max[0],1.1*Z.min[0]]),C&&(Y.yaxis.range=[1.1*Z.max[1],1.1*Z.min[1]]);var ee,te={marker:{symbol:m,size:f,line:{color:A,width:G}},legend:y,colors:copy_2d_array(d),mirror_x:B,vColor:I};ee=E?j.scores_plus:j.scores,Plotly.newPlot("chart1",chart_data2(n,i,ee,j.origin_dimensions,u,o,M,te),Y),Y={xaxis:{title:{text:"Component"},color:"black"},yaxis:{title:{text:"Eigenvalue"},color:"black"},yaxis2:{title:{text:"Cumulative variance (%)"},overlaying:"y",side:"right",color:"black",zeroline:!1,range:[0,100]},title:g,titlefont:{size:b},paper_bgcolor:x,plot_bgcolor:w,showlegend:!1,marker:{symbol:m}};var re={colors:d,borderColor:T,borderWidth:D},ae=scree_data(j.eval_table,re,v),ne=0,oe=0,le=0;for(let e=0;e<j.COV.length;e++)e<u&&(oe+=j.COV[e][e],ne+=j.eval_table[1][e]),le+=j.COV[e][e];var se=xrd(ae[1].y[u-1],v),ie=xrd(100*oe/le,v);function ce(e,t,r){void 0===r&&(r=4);return html_table(!1,"",t,"def","def","def","def","tableLeft","def",e,"",div=!0,r,.05,"","","","","table-responsive")}X="The original variance appears along the diagonal of the covariance matrix, ",X+="while the principal components variance  is represented by the eigenvalues.<br>",X+="The total variance across all dimensions is: "+xrd(le,v)+". ",X+="The original "+u+" dimensions, account  for "+ie+"% of the variance ("+xrd(oe,v)+")",X+=", while the  "+u+" principle components, explains "+se+"% of the variance.("+xrd(ne,v)+").<br>",set_variable("message1",X),Plotly.newPlot("chart2",ae,Y),display_blocks("notes","none"),display_blocks("results,rblock",""),GEBI("r1").scrollIntoView({behavior:"smooth"}),gtag("event",_,{event_category:"chart",event_label:"Scale:"+p,value:"Col:"+a.length+" rows:"+a[0].length})}function pca(e,t,r,a){var n,o,l,s,i=standardized(t,!0,a);"cov"==e?(o=cov_matrix(i),n="FALSE"):"cor"==e?(o=cor_matrix(i),n="TRUE"):(l=cov_matrix(i),o=math.multiply(l,math.transpose(l)));try{s=math.eigs(o),eigen=s.values}catch(e){alert("no eigenvector")}var c=math.transpose(s.vectors),h=[],_=[],u=[[],[],[],[]],v=sum1(s.values);for(let e=0;e<c.length;e++)_.push(c[c.length-1-e]),u[0].push("PC"+small_digit(e+1)),u[1].push(s.values[c.length-1-e]),0==e?(u[2].push(100*u[1][e]/v),u[3].push(100*u[1][e]/v)):(u[2].push(100*u[1][e]/v),u[3].push(u[3][e-1]+100*u[1][e]/v));for(let e=0;e<Math.min(r,c.length);e++)h.push(c[c.length-1-e]);var p=math.multiply(math.transpose(i),math.transpose(_));p.unshift([]);for(let e=0;e<p[1].length;e++)p[0].push("PC"+small_digit(e+1));var d=math.multiply(math.transpose(i),math.transpose(h));d.unshift([]);for(let e=0;e<d[1].length;e++)d[0].push("PC"+small_digit(e+1));var g=i.length,b=math.transpose(copy_2d_array(i)),m=math.identity(g)._data,f=[];for(let e=0;e<g;e++)f.push(0);for(let e=0;e<m.length;e++)b.push(f),b.push(m[e]);var y=math.multiply(b,math.transpose(h));y.unshift([]);for(let e=0;e<y[1].length;e++)y[0].push("PC"+small_digit(e+1));var x,w=copy_2d_array(t);for(let e=0;e<w.length;e++)w[e].unshift("x"+(e+1));x=a?"scale(df1)":"df1";var I="rm(list = ls())<br>";return I+=r_data_frame("df1",w),I+="rs1 = princomp("+x+", cor = "+n+")<br>",I+="rs1$scores<br>",I+="summary(rs1)<br>",I+="plot(rs1)<br>",{scores_plus:y,std_table:i,COV:o,scores:d,scores_total:p,eval_table:u,evector:_,origin_dimensions:g,r_code:I+="biplot(rs1)<br>"}}function c_rerun(){rerun_function("tab1",calculate_pca)}function oren(){var e=standardized([[1,5,1,5,8],[2,5,4,3,1],[3,6,2,2,2],[4,7,3,1,2]]),t=cov_matrix(e),r=math.eigs(t).vectors,a=math.transpose(r),n=[a[3],a[2]];math.multiply(math.transpose(e),math.transpose(n))}function cov_matrix_pop(e){var t,r,a=e.length,n=create_array(a,a,0);for(t=0;t<e.length;t++)for(r=t;r<e.length;r++)n[t][r]=covariance_pop(e[t],e[r]),t!=r&&(n[r][t]=n[t][r]);return n}function change_h1(){var e,t=get_var("h1"),r=count_numbers(get_data("c1",get_split_values())),a="#ab1313",n="<span style='color:#ab1313':>second column</span>";"ID"==t||0==r?(GEBI("h1").style.color=a,GEBI("c1").style.color=a,e="<span class='mb-2'>",e+="ID"==t?"Seeing as the header of the "+n+" is 'ID', ":"Seeing as the "+n+" doesn't include numbers, ",e+="we use this column as a second header (to convey further information), and this data will be visible when hovering over the markers (points).</span><br>"):(GEBI("h1").style.color="",GEBI("c1").style.color="",e=""),set_var("notes",e)}function increaseHue(e,t){var r=hexToRgb(e),a=rgbToHsl(r.r,r.g,r.b);a[0]=t*a[0];var n=hslToRgb(a[0],a[1],a[2]);return rgbToHex(n[0],n[1],n[2])}function hexToRgb(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(e,t,r,a){return t+t+r+r+a+a}));var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function rgbToHex(e,t,r){return"#"+((1<<24)+(e<<16)+(t<<8)+r).toString(16).slice(1)}function hslToRgb(e,t,r){var a,n,o;if(0==t)a=n=o=r;else{function l(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}var s=r<.5?r*(1+t):r+t-r*t,i=2*r-s;a=l(i,s,e+1/3),n=l(i,s,e),o=l(i,s,e-1/3)}return[255*a,255*n,255*o]}function rgbToHsl(e,t,r){e/=255,t/=255,r/=255;var a,n,o=Math.max(e,t,r),l=Math.min(e,t,r),s=(o+l)/2;if(o==l)a=n=0;else{var i=o-l;switch(n=s>.5?i/(2-o-l):i/(o+l),o){case e:a=(t-r)/i+(t<r?6:0);break;case t:a=(r-e)/i+2;break;case r:a=(e-t)/i+4}a/=6}return[a,n,s]}function printTable(e){for(var t=document.getElementById(e),r=window.open(""),a="",n=0;n<document.styleSheets.length;n++)a+="<link rel='stylesheet' href='"+document.styleSheets[n].href+"'>";r.document.head.innerHTML=a,r.document.body.innerHTML=t.outerHTML,r.print(),r.close()}covariance_pop=function(e,t){for(var r=jStat.mean(e),a=jStat.mean(t),n=e.length,o=new Array(n),l=0;l<n;l++)o[l]=(e[l]-r)*(t[l]-a);return jStat.sum(o)/n};